{% extends "base.html" %}

{% block content %}
<section class="container" style="padding: 2rem 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 class="section-title" style="margin-bottom: 0.5rem;">Menu Management</h1>
            <div style="display: flex; gap: 1rem;">
                <a href="/admin" style="text-decoration: none; color: var(--text-muted); font-weight: 500;">Orders</a>
                <a href="/admin/menu"
                    style="text-decoration: none; color: var(--primary-color); font-weight: 700; border-bottom: 2px solid var(--primary-color);">Menu</a>
            </div>
        </div>
        <button onclick="openModal()" class="add-btn">
            <span style="font-size: 1.2rem; margin-right: 0.5rem;">+</span> Add Item
        </button>
    </div>

    <!-- Canteen Filter Tabs -->
    <div style="margin-bottom: 2rem; display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 0.5rem;">
        <a href="/admin/menu" class="filter-tab {% if not current_canteen %}active{% endif %}">All</a>
        {% for canteen in canteens %}
        <a href="/admin/menu?canteen={{ canteen }}"
            class="filter-tab {% if current_canteen == canteen %}active{% endif %}">
            {{ canteen }}
        </a>
        {% endfor %}
    </div>

    <div class="menu-grid">
        {% for item in items %}
        <div class="menu-card admin-card">
            <img src="{{ item.image_url }}" alt="{{ item.name }}" class="card-img" style="height: 150px;">
            <div class="card-content">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <span class="card-category">{{ item.canteen }}</span>
                        <h3 class="card-title" style="font-size: 1.1rem; margin-top: 0.5rem;">{{ item.name }}</h3>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">{{ item.category
                            }}</p>
                    </div>
                </div>

                <div class="card-footer" style="margin-top: 0.5rem; padding-top: 0.5rem;">
                    <span class="price">‚Çπ{{ item.price }}</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editItem('{{ item.id }}')" class="icon-btn edit">‚úé</button>
                            <button onclick="deleteItem('{{ item.id }}')" class="icon-btn delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted);">
        No menu items found. Add one to get started!
    </div>
    {% endfor %}
    </div>
</section>

<!-- Add/Edit Modal -->
<div id="item-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 id="modal-title" class="section-title" style="margin-bottom: 1.5rem;">Add Menu Item</h2>

        <form id="item-form" method="POST" action="/admin/menu/add">
            <input type="hidden" name="id" id="item-id">

            <div class="form-group">
                <label>Item Name</label>
                <input type="text" name="name" id="item-name" class="form-input" required>
            </div>

            <div class="row" style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex: 1;">
                    <label>Price (‚Çπ)</label>
                    <input type="number" step="0.01" name="price" id="item-price" class="form-input" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Category</label>
                    <select name="category" id="item-category" class="form-input" required>
                        <option value="Breakfast">Breakfast</option>
                        <option value="Lunch">Lunch</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Dinner">Dinner</option>
                        <option value="Beverages">Beverages</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Canteen</label>
                <select name="canteen" id="item-canteen" class="form-input" required>
                    {% for canteen in canteens %}
                    <option value="{{ canteen }}">{{ canteen }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Image URL</label>
                <input type="url" name="image_url" id="item-image" class="form-input" placeholder="https://..."
                    required>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="available" id="item-available" checked>
                    Available for Ordering
                </label>
            </div>

            <button type="submit" class="checkout-btn">Save Item</button>
        </form>
    </div>
</div>

<style>
    .filter-tab {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 9999px;
        text-decoration: none;
        color: var(--text-main);
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .filter-tab.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .admin-card .card-img {
        height: 140px;
    }

    .icon-btn {
        background: #f3f4f6;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .icon-btn:hover {
        background: #e5e7eb;
    }

    .icon-btn.delete:hover {
        background: #fee2e2;
        color: #ef4444;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
    }
</style>

<script>
    const modal = document.getElementById('item-modal');
    const form = document.getElementById('item-form');
    const modalTitle = document.getElementById('modal-title');

    // Robust Data Passing
    // Load pre-serialized data from backend
    const rawItems = {{ items_data | tojson | safe }};
    const MENU_DATA = {};

    rawItems.forEach(item => {
        MENU_DATA[String(item.id)] = item;
    });

    console.log("MENU_DATA Loaded:", Object.keys(MENU_DATA).length, "items");

    function openModal() {
        form.action = "/admin/menu/add";
        form.reset();
        document.getElementById('item-id').value = '';
        modalTitle.innerText = "Add Menu Item";
        modal.classList.add('active');
    }

    function editItem(id) {
        console.log("Editing Item ID:", id);
        // Ensure ID is treated as string for lookup
        const item = MENU_DATA[String(id)];

        if (!item) {
            console.error("Item not found in MENU_DATA for ID:", id);
            alert("Error: Could not load item details. Please refresh.");
            return;
        }

        console.log("Item Details:", item);
        form.action = `/admin/menu/edit/${item.id}`;
        document.getElementById('item-id').value = item.id;
        document.getElementById('item-name').value = item.name;
        document.getElementById('item-price').value = item.price;
        document.getElementById('item-category').value = item.category;
        document.getElementById('item-canteen').value = item.canteen;
        document.getElementById('item-image').value = item.image_url;
        document.getElementById('item-available').checked = item.available;

        modalTitle.innerText = "Edit Item";
        modal.classList.add('active');
    }

    function closeModal() {
        modal.classList.remove('active');
    }

    async function deleteItem(id) {
        if (!confirm('Are you sure you want to delete this item?')) return;

        const response = await fetch(`/admin/menu/delete/${id}`, { method: 'POST' });
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete item');
        }
    }

    window.onclick = function (event) {
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}